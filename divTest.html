<html class="no-js" lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Webapp Layout Test</title>
    <link rel="stylesheet" href="external/css/foundation.css" />

    <style>
    .menu-bar {
        height:40px;
        background:lightgrey;
        box-shadow: 5px 5px 5px #909090;
    }

    .container {
        flex: 1;
        display: flex;
    }

    .content-block {
        margin: 0  auto auto 0;
    }

    .column-items {
        flex-direction: column;
    }

    .row-items {
        flex-direction: row;
    }

    .edit-border-style {
        border: gainsboro;
        border-width: thin;
        border-style: solid;
        padding: 10px;
        margin: 10px;
        box-shadow: 2px 2px 2px #909090;
        border-radius: 0px;
    }
    .border-style {
        border: gainsboro;
        border-width: thin;
        border-style: solid;
        padding: 0px;
        margin: 0px;
/*         box-shadow: 2px 2px 2px #909090; */
    }


    #outer {
        display:flex;
        flex-direction:column;
    }

    #main {
        bottom: 0px;
        top: 0px;
        left: 0px;
        right: 0px;
        position: relative;
        flex: 1;
        display: flex;
    }
    #outer {
        position: relative;
        width: 100%;
        height: 100%;
    }

    .ctxMenu{
        display:none;
        z-index:100;
    }

    .ctx-menu {
        position:absolute;
        display:block;
        left:0px;
        top:0px;
        height:20px;
        width:20px;
        padding:0;
        margin:0;
        border:1px solid;
        background-color:white;
        font-weight:normal;
        white-space:nowrap;
    }
    .ctx-menu:hover{
        background-color:#eef;
        font-weight:bold;
    }
    .ctx-menu:hover > menu{
        display:block;
    }
    .ctx-menu > menu{
        display:none;
        position:relative;
        top:-20px;
        left:100%;
        width:140px;
    }
    .ctx-menu[title]:before{
        content:attr(title);
    }
    .ctx-menu:not([title]):before{
        content:"\2630";
    }
    </style>
</head>
<body>
    <div id='outer'>

        <div id='top-menu' class='menu-bar'>
            <ul class="dropdown menu" data-dropdown-menu>
              <li>
                <a>File</a>
                <ul class="menu">
                  <li><a href="#0">Open</a></li>
                  <li>
                    <a href='#0'> Recent</a>
                    <ul class='menu'>
                      <li><a href='#0'>Item 1 subA</a></li>
                      <li><a href='#0'>Item 1 subB</a></li>
                    </ul>
                  </li>
                </ul>
              </li>
              <li> <a href='#0'> Edit </a>
                <ul class="menu">
                  <li><a href='#0'>Preferences</a></li>
                </ul>
              </li>
              <li><a href='#0'> Layout </a>
                <ul class='menu'>
                    <li><a href='#0' id='tm-layout'>Edit</a></li>
                    <li><a href='#0' id='tm-layout-save'>Save</a></li>
                    <li><a href='#0' id='tm-layout-load' onclick="$('#tm-layout-load-file').click()">Load</a>
                        <input type="file" id="tm-layout-load-file" style="display: none;" />
                    </li>
                </ul>
              </li>
            </ul>
        </div>
            <div id="main" class='border-style column-items'>
            </div>
        <div id='status-bar' class='menu-bar'> 
        # ...
        </div>
    </div>

    <script src="external/js/vendor/jquery.js"></script>
    <script src="external/js/vendor/what-input.js"></script>
    <script src="external/js/vendor/foundation.js"></script>
    <script src="external/js/app.js"></script>
    <script src='external/jquery-3.1.1.js'></script>

    <script>
        NELEMENTS = 0;
        var TEST;
        var main = $("#main")[0];
        make_menu(main, 'main');
        main.addEventListener("contextmenu", show_menu, false);
        main.addEventListener("click", clear_menu, false);

        function make_menu(elem, number){
            var menu = '';
            menu += '\
            <menu class="ctx-menu ctxMenu" style="display:none" id="ctxMenu' + number + '"> \
            <menu title="Add Container" class="ctx-menu" onclick="addContainer(this)"> \
            </menu> '
            if (number != 'main'){
                menu += '<menu title="Remove Container" class="ctx-menu" onclick="removeContainer(this)"> \
                </menu>'
            }
            menu += '<menu title="Align" class="ctx-menu"> \
                         <menu title="Vertical" class="ctx-menu"  onclick="alignVertical(this)"> </menu>  \
                         <menu title="Horizontal" class="ctx-menu" onclick="alignHorizontal(this)"></menu> \
                </menu> \
            </menu>'
            elem.innerHTML += menu;
        }

        function make_container_block(elem) {
            elem.innerHTML += "\
                <div class='content-block layout-block'><table><tbody> \
                <tr>\
                    <td>Width:</td> \
                    <td><input type='number' min=0 max=2048 class='layout-width' value='1' onchange='boxWidthChange(this)'> \
                    </input> </td> \
                    <td> <select class='unit' onchange='boxWidthChange(this)'> \
                          <option value='flex'>flex</option> \
                          <option value='px'>px</option> \
                         </select> \
                    </td> \
                </tr> \
                <tr>\
                    <td>Height:</td> \
                    <td><input type='number' min=0 max=2048 class='layout-width' value='1' onchange='boxHeightChange(this)'> \
                    </input> </td> \
                    <td> <select class='unit' onchange='boxHeightChange(this)'> \
                          <option value='flex'>flex</option> \
                          <option value='px'>px</option> \
                         </select> \
                    </td> \
                </tr> \
                </tbody></table></div>"
        }

        function show_menu(event){
            if ($('#tm-layout').data('clicks')) {
                var number = event.target.id;
                clear_menu();
                event.stopPropagation();
                event.preventDefault();
                var ctxMenu = $("#ctxMenu" + number)[0];
                ctxMenu.style.display = "block";
                ctxMenu.style.left = (event.pageX - 10)+"px";
                ctxMenu.style.top = (event.pageY - 60)+"px";
            }
        };

        function clear_menu(){
            var ctxMenus = $(".ctxMenu");
            for (var i=0; i < ctxMenus.length; i++){
                ctxMenus[i].style.display = "none";
                ctxMenus[i].style.left = "";
                ctxMenus[i].style.top = "";    
            }

        };

        function removeContainer(elem){
            //parentElement = $(this).parent('div')
            parentElem = elem.parentElement.parentElement
            if (parentElem.id != 'main'){
                parentElem.remove();
            }
        }

        function addContainer(elem){
            parentElem = elem.parentElement.parentElement;
            div = document.createElement('div');
            div.className = 'container edit-border-style row-items';
            parentElem.appendChild(div);
            div.id = NELEMENTS + 1;
//             div.innerHTML = NELEMENTS + 1;
            NELEMENTS += 1;
            make_menu(div, div.id);
            make_container_block(div);
            div.addEventListener("contextmenu", show_menu, false);
            div.addEventListener("click", clear_menu, false);
        }

        function alignVertical(melem){
            elem = melem.parentElement.parentElement.parentElement;
            elem.classList.remove("row-items")
            elem.classList.add("column-items")
        }
        function alignHorizontal(melem){
            elem = melem.parentElement.parentElement.parentElement;
            elem.classList.remove("column-items")
            elem.classList.add("row-items")
        }

        // Function for layout box
        function boxSizeChange(melem, wh){
            var elem = $(melem).closest('div').parent();
            var tr = $(melem).closest('tr');
            var unit = $(tr).find('select')[0].value;
            var size = $(tr).find('input')[0].value;
            if (unit == 'flex'){
                elem.css('flex', size);
                elem.css('max-' + wh, '');
                inputs = elem.find('input');
                for (var i = 0; i < inputs.length; i++){
                    var u = $(inputs[i]).closest('tr').find('select')[0].value;
                    if (u == 'flex'){
                        inputs[i].value = size;
                    }
                }
            } else if (unit == 'px') {
                elem.css('flex', '');
                elem.css('max-'+ wh, size + unit);
            }
        }

        function boxWidthChange(melem){
            boxSizeChange(melem, 'width');
        }
        function boxHeightChange(melem){
            boxSizeChange(melem, 'height');
        }

        // JQuery Magic
        $(document).ready(function(){
            $('#tm-layout').click(function() {
              var clicks = $(this).data('clicks');
              if (clicks) {
                $('.container').addClass("border-style");
                $('#main').addClass("border-style");
                $('.container').removeClass("edit-border-style");
                $('#main').removeClass("edit-border-style");
                $(this).text('Edit'); 
                $('.layout-block').hide();
              } else {
                $('.container').removeClass("border-style");
                $('#main').removeClass("border-style");
                $('.container').addClass("edit-border-style");
                $('#main').addClass("edit-border-style");
                $(this).html(' &#8594; Edit');
                $('.layout-block').show();
              }
              $(this).data("clicks", !clicks);
            });

            $('#tm-layout-save').click(function(){
               exportLayout(); 
            });

            $('#tm-layout-load-file').change(function (e) {
                var layout;
                function callback(result) {
                    layout = JSON.parse(result);
                    TEST = layout;  // DEBUG TODO: remove this
                    console.log("Remove above debugging line.")
                    importLayout(layout);
                }
                readSingleFile(e, callback);
                });
        }); // end of document.ready

        function exportLayout(){
            // Build the json structure defining the layout
            var main = $('#main');
            var layout = {
                divMain: {
                    divType: 'container', //has to be a container
                    classes: main.attr('class'),
                    id: main.attr('id'),
                    data: {
                        contents: containerContents(main)
                    }
                }
            }
            download('layout.json', JSON.stringify(layout));
            
        }
        function containerContents(elem){
            var contents = [];
            var children = $(elem).children('div');
            for (var i = 0; i < children.length; i++){
                var child = $(children[i]);
                contents.push({
                   divType: 'container',
                   classes: child.attr('class'),
                   id: child.attr('id'),
                   style: child.attr('style'),
                   data: {
                       contents: containerContents(child),
                       width: child.css('max-width'),
                       height: child.css('max-height'),
                       flex: child.css('flex')
                   }
                });
            }
            return contents;
        }

        function importLayout(layout){

        }

        // Downloading a file: http://stackoverflow.com/questions/3665115/create-a-file-in-memory-for-user-to-download-not-through-server
        function download(filename, text) {
          var element = document.createElement('a');
          element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
          element.setAttribute('download', filename);

          element.style.display = 'none';
          document.body.appendChild(element);

          element.click();

          document.body.removeChild(element);
        }

        // Future functions
        // Looks like importing is trickier: https://www.html5rocks.com/en/tutorials/file/dndfiles/

        // Importing/reading a single file: http://stackoverflow.com/questions/3582671/how-to-open-a-local-disk-file-with-javascript
        function readSingleFile(e, callback) {
          var file = e.target.files[0];
          if (!file) {
            return;
          }
          var reader = new FileReader();
          reader.onload = function (e) {
              callback(reader.result);
          }
          // This function is asynchronous, which means we have no idea when it will happen. 
          // As such, after it's finished, we need to have a callback to do something with the
          // results. Hence the above callback function.
          reader.readAsText(file);
        }

        

    </script>


</body>
</html>

